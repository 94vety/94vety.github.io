---
title: TCP
description: 传输控制协议（TCP，Transmission Control Protocol）是一种面向连接的、可靠的、基于字节流的传输层通信协议.
tags:  
- Network
---

## TCP 传输控制协议

* TCP 全称是传输控制协议，是一种面向有连接、安全可靠的、基础字节流的传输控制协议。

#### TCP 特性

* 1、面向连接
&nbsp;&nbsp;&nbsp;&nbsp;在发送数据前，双方需要建立连接，才能进行数据的正常发送.

* 2、仅支持单播传送
&nbsp;&nbsp;&nbsp;&nbsp;每条 TCP 传送只能在两个端点，之间进行点对点的传输，不支持多播、广播.

* 3、面向字节流
&nbsp;&nbsp;&nbsp;&nbsp;TCP不像UDP那样一个报文一个报文独立传输，而是在不保存报文边界的情况下以字节流的形式传输.

* 4、可靠性
&nbsp;&nbsp;&nbsp;&nbsp;TCP为了保证传输的可靠性给每一个包一个序号，同时也保证了传输到接收方的包是按序排列. 接收方对于已经接受的包会回传一个相应的确认（ACK），如果发送方在确认的往返时延（RTT）没有收到确认，就会重新发送.

* 5、提供拥塞控制
&nbsp;&nbsp;&nbsp;&nbsp;当网络出现阻塞的时候，TCP会减少发送数量和发送速率.

* 6、全双工通信
&nbsp;&nbsp;&nbsp;&nbsp;TCP允许通信的双方应用程序在任何时候发送数据，因为TCP在两端都设有缓存，来存放临时通信数据. TCP可以马上发送数据段，也可以缓存等待一段时候在发数据段，以便一次发送更多的数据（最大的数据段取决于MSS）.

***

#### 面向字节流

1. 两者的区别在于 TCP 接收的是一堆数据，而每次取多少由主机决定，而 UDP 发的是数据报，客户发送多少就接收多少.<br>
2. 拥有这些区别的原因是由于 TCP 和 UDP 的特性不同而决定的.<br>
3. TCP 是面向连接的，也就是说，在连接持续的过程中，socket 中收到的数据都是由同一台主机发出的，因此，知道保证数据是有序的到达就行了，至于每次读取多少数据自己看着办<br>. 
4. UDP是无连接的协议，也就是说，只要知道接收端的 IP 和端口，且网络是可达的，任何主机都可以向接收端发送数据. 这时候，如果一次能读取超过一个报文的数据，则会乱套. 比如，主机 A 向发送了报文 P1，主机 B 发送了报文 P2，如果能够读取超过一个报文的数据，那么就会将 P1 和 P2 的数据合并在了一起，这样的数据是没有意义的.<br>

***

## 拥塞控制

* TCP 通过减少发送窗口大小来处理拥塞，发送窗口的大小由以下两个因素共同决定：

1、接收窗口大小（receiver window）<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;接收窗口大小是一种接收端对发送端的告知，用来说明接收者总计能接收多少字节未确认数据.<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;发送者通过 TCP 头得知接收者接收窗口大小.<br>

2、拥塞窗口大小（congestion window）<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;发送者发送的未确认数据应小于等于拥塞窗口大小，拥塞窗口的概念只存在于发送端.<br>

3、发送窗口大小<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;取接收窗口大小和拥塞窗口大小的最小值.<br>

***

#### TCP 应对拥塞的策略

* TCP 应对阻塞的三个阶段
&nbsp;&nbsp;&nbsp;&nbsp;1、慢启动（Slow Start）<br>
&nbsp;&nbsp;&nbsp;&nbsp;2、拥塞避免（Congestion Avoidance）<br>
&nbsp;&nbsp;&nbsp;&nbsp;3、拥塞探知（Congestion Detection）<br>

* 慢启动阶段

一开始发送端设置拥塞窗口等于一个最大报文段（1 MSS），在接收到确认 ACK 后，发送端把拥塞窗口增加 1 MSS，整个过程中拥塞窗口按照预设规则增大（指数级）.

![慢启动](https://s1.ax1x.com/2020/10/28/B8icE6.png)

1、第一轮 ack，拥塞窗口 = 2 MSS<br>
2、第二轮 ack，拥塞窗口 = 4 MSS<br>
3、第三轮 ack，拥塞窗口 = 8 MSS<br>

上述过程一直轮询，知道拥塞窗口的大小达到慢启动的阀值.

* 拥塞避免阶段

1、拥塞窗口达到阈值后，为避免拥塞发送端改为线性的增加拥塞窗口大小.<br>
2、接收到每个 ACK 后，发送端只对拥塞窗口增加 1 MSS.<br>
3、整个过程一直持续，直到拥塞窗口大小增大到接收窗口大小.<br>

![拥塞避免](https://s1.ax1x.com/2020/10/28/B8AGDA.png)

* 拥塞感知阶段

发送端检测到报文丢失时，根据不同方式感知到的报文丢失会采取不同的策略来进行处理.<br>

**通过超时感知拥塞（Time Out）**<br>
接收者经历超时时间后却没有收到报文确认的 ack，说明有大概率存在网络拥塞，这时报文段可能已经丢失.<br>

发送端应对策略<br>
1、设置慢启动阀值为当前拥塞窗口大小的一半.<br>
2、设置拥塞窗口大小为 1 MSS.<br>
3、恢复到慢启动阶段.<br>

**收到三个重复 ACK 感知拥塞**<br>

发送端接收到三个重复的 ack 说明存在小概率网络拥塞，虽然报文存在丢失的可能，但接下来发送的报文应该可以顺利到达.<br>

发送端应对策略<br>
1、设置慢启动阀值为当前拥塞窗口大小的一半.<br>
2、拥塞窗口减小到慢启动阀值的一半.<br>
3、恢复到拥塞避免阶段.<br>

***

## 差错控制

差错控制就是为了当应用程序将数据交付给 TCP 后，就依靠 TCP 将整个数据流**按序**、**没有损坏**、**没有丢失**，**没有重复**的交付给另一端的应用程序.<br>
**差错控制的方法：**<br>
1、校验和<br>
2、确认应答<br>
3、重传<br>

* 校验和

TCP 可以通过校验和字段检测出数据是否损坏，每一个**TCP**首部 都会包含**校验和**字段，当检测到数据损坏时，由**接收方 TCP**将损坏的报文段丢失.

* 确认应答

在 TCP 中，发送端的数据到达接收端时，接收段会返回一个 ack，代表收到了消息，这个 ack 便是确认应答.

* 重传

***

## 流量控制

通过流量控制，**发送端**将不会随心所欲的发送数据，而是根据需要**接受端的实际能力控制发送的数据量**.

* 窗口

1、TCP 以一个段为单位，每发送一个段就要进行一次确认应答（ACK）处理，这样传输的方式有一个缺点，就是包的往返时间越长，效率越低.

![窗口1](https://s1.ax1x.com/2020/10/29/B8d61S.png)

2、所以引入了**窗口**这个概念，在窗口范围内，即使没有收到 ack，也可以继续发送数据，无需一直等待 ack，这个机制的实现使用了大量的缓存区.<br>
3、接受端接收到多个段后，同时对多个段一起回复 ack.

![窗口2](https://s1.ax1x.com/2020/10/29/B8d71U.md.png)

4、TCP 首部中带有**窗口大小**字段，在返回 ack 时，就会带上这个字段，接受端接收到这个字段后，就会对自己的**窗口大小**进行更新（滑动）.<br>
5、如果返回的**窗口大小**为 0，表示**接受端缓存区**已满，发送端将会停止发送数据，等待一段时间后，会发送**窗口探测**的包，探测目前**窗口大小**是否可以更新.

![窗口3](https://s1.ax1x.com/2020/10/29/B8dHcF.md.png)

* 滑动窗口

**窗口大小更新的概念，又名窗口滑动**

1、已发送并被确认数据可以从缓存区清除.<br>
2、5~8 的数据被发送之后，还未收到 ack，但由于其**窗口大小**可以容纳 10 个 MSS，所以可以继续发送 9～14 的数据.<br>
3、15~18 是后续需要发送的数据，但由于**流量控制**，暂时不能发送.<br>
4、当收到了 5~8 的 ack，**发送窗口**整体向右滑动，使新的数据进入到窗口中，新的数据得以发送.<br>
5、窗口按照以上规律不断向前滑动，因此这种机制被称为：**滑动窗口机制**.<br>

其实除了**发送窗口**，接受端也有自己的**接收窗口**，只有在**接收窗口**滑动时（同时发送 ack），**发送窗口**才有可能滑动，并且**发送窗口**始终小于**接收窗口**.

***

## 参考

* 对下述文章表示感谢

https://juejin.im/post/6844904031760941069#heading-20<br>
https://juejin.im/post/6861491957534261255#heading-10<br>
https://segmentfault.com/a/1190000024573031<br>
https://juejin.im/post/6861491957534261255#heading-4<br>


mss，窗口计算
https://juejin.im/post/6844904029244358669#heading-3
https://juejin.im/post/6861491957534261255#heading-10

tcp 重传
https://segmentfault.com/a/1190000021064727
https://juejin.im/post/6844904023095509000#heading-1